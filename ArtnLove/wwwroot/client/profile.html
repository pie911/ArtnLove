<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Profile â€” ArtnLove</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/client/css/site.css">
    <style>
      .profile-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin: -1rem -1rem 2rem -1rem;
      }
      .avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(45deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: bold;
        color: white;
        margin: 0 auto 1rem;
      }
      .profile-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
      }
      .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
      }
      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
      }
      .stat-label {
        color: #666;
        margin-top: 0.5rem;
      }
      .edit-profile-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <!-- Navigation -->
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-lg mb-4">
        <div class="container-fluid">
          <a class="navbar-brand fw-bold d-flex align-items-center" href="/">
            <i class="bi bi-palette-fill me-2"></i>
            <span>ArtnLove</span>
          </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
              <li class="nav-item">
                <a class="nav-link" href="/client/index.html">
                  <i class="bi bi-house-door me-1"></i>Home
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/client/upload.html">
                  <i class="bi bi-cloud-upload me-1"></i>Upload
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="/client/profile.html">
                  <i class="bi bi-person me-1"></i>Profile
                </a>
              </li>
            </ul>
            <ul class="navbar-nav">
              <li class="nav-item">
                <button class="dark-mode-toggle btn btn-link nav-link me-3" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                  <i class="bi bi-moon"></i>
                </button>
              </li>
              <li class="nav-item user-menu" id="userMenu">
                <div class="dropdown">
                  <button class="btn btn-link nav-link dropdown-toggle text-white text-decoration-none d-flex align-items-center" type="button" data-bs-toggle="dropdown">
                    <span class="badge bg-light text-primary rounded-circle me-2" id="userAvatar">U</span>
                    <span id="userDisplayName">User</span>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="/client/profile.html"><i class="bi bi-person me-2"></i>Profile</a></li>
                    <li><a class="dropdown-item" href="/client/upload.html"><i class="bi bi-cloud-upload me-2"></i>Upload Art</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                  </ul>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <div id="profileContent">
        <div class="text-center mb-4">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p>Loading profile...</p>
        </div>
      </div>

      <!-- Edit Profile Modal -->
      <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Edit Profile</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProfileForm">
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="editDisplayName" class="form-label">Display Name</label>
                    <input type="text" class="form-control" id="editDisplayName">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="editRole" class="form-label">Role</label>
                    <select class="form-control" id="editRole">
                      <option value="buyer">Art Buyer</option>
                      <option value="seller">Art Seller</option>
                    </select>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="editBio" class="form-label">Bio</label>
                  <textarea class="form-control" id="editBio" rows="3"></textarea>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="editLocation" class="form-label">Location</label>
                    <input type="text" class="form-control" id="editLocation">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="editWebsite" class="form-label">Website</label>
                    <input type="url" class="form-control" id="editWebsite">
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      // API Base URL
      const API_BASE = 'http://localhost:5068/api/v1';

      // Auth state
      let currentUser = null;
      let authToken = localStorage.getItem('authToken');

      // Initialize
      document.addEventListener('DOMContentLoaded', function() {
        if (!authToken) {
          window.location.href = '/client/index.html';
          return;
        }
        loadProfile();
      });

      // Load profile
      async function loadProfile() {
        try {
          const response = await fetch(`${API_BASE}/auth/me`, {
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });

          if (response.ok) {
            const data = await response.json();
            currentUser = data.user;
            displayProfile(currentUser);
          } else {
            showMessage('Failed to load profile', 'error');
            localStorage.removeItem('authToken');
            window.location.href = '/client/index.html';
          }
        } catch (error) {
          console.error('Error loading profile:', error);
          showMessage('Error loading profile', 'error');
        }
      }

      // Display profile
      function displayProfile(user) {
        const profileContent = document.getElementById('profileContent');
        profileContent.innerHTML = `
          <div class="card position-relative">
            <div class="profile-header">
              <div class="container">
                <div class="avatar mx-auto">${(user.display_name || user.email).charAt(0).toUpperCase()}</div>
                <h2 class="text-center mb-0">${user.display_name || 'User'}</h2>
                <p class="text-center mb-0 opacity-75">${user.email}</p>
                <button class="btn btn-light edit-profile-btn" onclick="showEditProfileModal()">
                  <i class="fas fa-edit"></i> Edit Profile
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-8">
                  <h4>About</h4>
                  <div class="mb-3">
                    <strong>Role:</strong> <span class="badge bg-primary">${user.role || 'Buyer'}</span>
                  </div>
                  ${user.bio ? `<div class="mb-3"><strong>Bio:</strong> ${user.bio}</div>` : ''}
                  ${user.location ? `<div class="mb-3"><strong>Location:</strong> ${user.location}</div>` : ''}
                  ${user.website ? `<div class="mb-3"><strong>Website:</strong> <a href="${user.website}" target="_blank">${user.website}</a></div>` : ''}
                </div>
                <div class="col-md-4">
                  <div class="profile-stats">
                    <div class="stat-card">
                      <div class="stat-number">0</div>
                      <div class="stat-label">Artworks</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-number">0</div>
                      <div class="stat-label">Following</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-number">0</div>
                      <div class="stat-label">Followers</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Show edit profile modal
      function showEditProfileModal() {
        document.getElementById('editDisplayName').value = currentUser.display_name || '';
        document.getElementById('editRole').value = currentUser.role || 'buyer';
        document.getElementById('editBio').value = currentUser.bio || '';
        document.getElementById('editLocation').value = currentUser.location || '';
        document.getElementById('editWebsite').value = currentUser.website || '';

        const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
        modal.show();
      }

      // Edit profile form handler
      document.getElementById('editProfileForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const displayName = document.getElementById('editDisplayName').value;
        const role = document.getElementById('editRole').value;
        const bio = document.getElementById('editBio').value;
        const location = document.getElementById('editLocation').value;
        const website = document.getElementById('editWebsite').value;

        try {
          const response = await fetch(`${API_BASE}/auth/profile`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
              displayName: displayName || null,
              bio: bio || null,
              location: location || null,
              website: website || null
            })
          });

          if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
            showMessage('Profile updated successfully!', 'success');
            // Reload profile
            loadProfile();
          } else {
            const data = await response.json();
            showMessage(data.message || 'Failed to update profile', 'error');
          }
        } catch (error) {
          console.error('Error updating profile:', error);
          showMessage('Error updating profile', 'error');
        }
      });

      // Logout
      function logout() {
        localStorage.removeItem('authToken');
        window.location.href = '/client/index.html';
      }

      // Message display
      function showMessage(message, type = 'info') {
        alert(message);
      }
    </script>
    <script src="/client/js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
